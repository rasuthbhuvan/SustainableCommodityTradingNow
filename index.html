<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
    // SUPABASE CONFIGURATION - Using your actual credentials
    const SUPABASE_URL = 'https://kunrareegagtlxiudfa.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt1bnJhcmllZWdhZ3RreGl1ZGZhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk1MTIyMjgsImV4cCI6MjA3NTA4ODIyOH0.cAcKViNIT6qI5eFM18IDaWKWsAIfwQ3gvugFo0iWbaI';
    
    const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    
    // Global variables to store data
    let allProducts = [];
    let allCategories = [];
    
    // Initialize the page
    document.addEventListener('DOMContentLoaded', function() {
        loadDataFromSupabase();
    });
    
    // Load all data from Supabase
    async function loadDataFromSupabase() {
        try {
            // Load categories
            const {  categories, error: catError } = await supabase
                .from('categories')
                .select('*');
                
            if (catError) throw catError;
            allCategories = categories || [];
            
            // Load products
            const {  products, error: prodError } = await supabase
                .from('products')
                .select('*')
                .eq('status', 'active');
                
            if (prodError) throw prodError;
            allProducts = products || [];
            
            // Render the page
            renderCategories();
            renderCategoryFilters();
            renderFormOptions();
            
        } catch (error) {
            console.error('Error loading ', error);
            // Fallback to default data if Supabase fails
            loadDefaultData();
        }
    }
    
    // Fallback default data (your original static data)
    function loadDefaultData() {
        allCategories = [
            { id: 'proteins', name: 'Sustainable Proteins', description: 'High-quality proteins derived from waste sources for various industrial applications' },
            { id: 'catalysts', name: 'Advanced Catalysts', description: 'Innovative catalysts from industrial waste streams for green manufacturing' }
        ];
        
        allProducts = [
            {
                id: 'poultry-protein',
                title: 'Poultry Waste-Derived Protein',
                category: 'proteins',
                monthly_capacity: '50 tons/month',
                overview: 'High-quality protein extracted from poultry waste streams',
                specifications: { 'Protein Content': '85-92%', 'Moisture': '<8%' }
            },
            {
                id: 'algae-protein', 
                title: 'Algae-Based Protein',
                category: 'proteins',
                monthly_capacity: '25 tons/month',
                overview: 'Sustainable protein derived from specially cultivated algae strains',
                specifications: { 'Protein Content': '60-70%', 'Omega-3 Content': '15-25%' }
            },
            {
                id: 'red-mud-pellets',
                title: 'Red Mud Pellets (ROSTA PELLET)', 
                category: 'catalysts',
                monthly_capacity: '500 tons/month',
                overview: 'Advanced catalyst pellets manufactured from red mud waste',
                specifications: { 'Al2O3 Content': '35-45%', 'Fe2O3 Content': '30-40%' }
            },
            {
                id: 'bio-catalysts',
                title: 'Bio-Catalysts',
                category: 'catalysts', 
                monthly_capacity: '10 tons/month',
                overview: 'Enzyme-based catalysts for sustainable chemical processing',
                specifications: { 'Enzyme Activity': '1000-5000 U/g', 'Temperature Range': '20-80Â°C' }
            }
        ];
        
        renderCategories();
        renderCategoryFilters();  
        renderFormOptions();
    }
    
    // Render categories grid
    function renderCategories() {
        const grid = document.getElementById('productsGrid');
        const categoryGroups = {};
        
        // Group products by category
        allProducts.forEach(product => {
            if (!categoryGroups[product.category]) {
                categoryGroups[product.category] = [];
            }
            categoryGroups[product.category].push(product);
        });
        
        let html = '';
        allCategories.forEach(category => {
            const products = categoryGroups[category.id] || [];
            const productCount = products.length;
            
            html += `
                <div class="category-card" data-category="${category.id}" onclick="openCategory('${category.id}')">
                    <div class="category-header">
                        <div>
                            <h3 class="category-title">${category.name}</h3>
                            <p class="category-description">${category.description}</p>
                        </div>
                        <span class="product-count">${productCount} products</span>
                    </div>
                    <ul class="product-list">
                        ${products.map(product => `
                            <li class="product-item" onclick="event.stopPropagation(); openProductModal('${product.id}')">
                                <div class="product-name">${product.title}</div>
                                <div class="product-capacity">Capacity: ${product.monthly_capacity || 'N/A'}</div>
                            </li>
                        `).join('')}
                    </ul>
                </div>
            `;
        });
        
        grid.innerHTML = html;
    }
    
    // Render category filters
    function renderCategoryFilters() {
        const filtersContainer = document.getElementById('categoryFilters');
        let html = '<button class="filter-btn active" onclick="filterCategory(\'all\')">All Categories</button>';
        
        allCategories.forEach(category => {
            html += `<button class="filter-btn" onclick="filterCategory('${category.id}')">${category.name}</button>`;
        });
        
        filtersContainer.innerHTML = html;
    }
    
    // Render form options
    function renderFormOptions() {
        // Interest area select
        const interestSelect = document.querySelector('select[name="interest"]');
        if (interestSelect) {
            let html = '<option value="">Select Category</option>';
            allCategories.forEach(category => {
                html += `<option value="${category.id}">${category.name}</option>`;
            });
            html += '<option value="custom">Custom Development</option>';
            interestSelect.innerHTML = html;
        }
        
        // Material select in quote modal
        const materialSelect = document.querySelector('select[name="material"]');
        if (materialSelect) {
            let html = '<option value="">Select Material</option>';
            
            allCategories.forEach(category => {
                const categoryProducts = allProducts.filter(p => p.category === category.id);
                if (categoryProducts.length > 0) {
                    html += `<optgroup label="${category.name}">`;
                    categoryProducts.forEach(product => {
                        html += `<option value="${product.id}">${product.title}</option>`;
                    });
                    html += '</optgroup>';
                }
            });
            
            html += '<option value="Custom Material Development">Custom Material Development</option>';
            html += '<option value="Pilot Program">Pilot Program</option>';
            materialSelect.innerHTML = html;
        }
    }

    // Contact settings for email routing
    const contactSettings = {
        primaryRecipient: 'admin@commoditytrading.com'
    };

    // Search functionality
    function searchProducts() {
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();
        const cards = document.querySelectorAll('.category-card');
        const noResults = document.getElementById('noResults');
        let hasResults = false;
        
        cards.forEach(card => {
            const text = card.textContent.toLowerCase();
            if (text.includes(searchTerm) || searchTerm === '') {
                card.style.display = 'block';
                hasResults = true;
            } else {
                card.style.display = 'none';
            }
        });

        noResults.style.display = hasResults ? 'none' : 'block';
    }

    // Filter by category
    function filterCategory(category) {
        const cards = document.querySelectorAll('.category-card');
        const filterBtns = document.querySelectorAll('.filter-btn');
        const noResults = document.getElementById('noResults');
        let hasResults = false;
        
        // Update active filter button
        filterBtns.forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');
        
        // Show/hide cards
        cards.forEach(card => {
            if (category === 'all' || card.dataset.category === category) {
                card.style.display = 'block';
                hasResults = true;
            } else {
                card.style.display = 'none';
            }
        });

        noResults.style.display = hasResults ? 'none' : 'block';
        document.getElementById('searchInput').value = '';
    }

    // Product modal functions
    function openProductModal(productId) {
        const product = allProducts.find(p => p.id === productId);
        if (!product) {
            alert(`Product details for: ${productId}`);
            return;
        }
        
        document.getElementById('modalLeft').innerHTML = `
            <h2>${product.title}</h2>
            <p>${product.overview || 'No overview available'}</p>
            <h3>Applications</h3>
            <p>${product.applications || 'Multiple industrial applications'}</p>
        `;
        
        let specs = '<h3>Specifications</h3>';
        if (product.specifications && typeof product.specifications === 'object') {
            for (let key in product.specifications) {
                specs += `<div><strong>${key}:</strong> ${product.specifications[key]}</div>`;
            }
        } else {
            specs += '<p>Specifications available on request</p>';
        }
        
        specs += `
            <div style="margin-top: 20px;">
                <strong>Monthly Capacity:</strong> ${product.monthly_capacity || 'Contact for details'}
            </div>
            <button onclick="openQuoteModal('${product.title}')" style="margin-top: 15px; padding: 10px 20px; background: #FFB400; border: none; border-radius: 5px; cursor: pointer;">
                Request Quote
            </button>
        `;
        
        document.getElementById('modalRight').innerHTML = specs;
        document.getElementById('productModal').style.display = 'flex';
    }
    
    function closeProductModal() {
        document.getElementById('productModal').style.display = 'none';
    }

    function openCategory(category) {
        console.log(`Opening ${category} category page`);
    }

    // Quote Modal Functions
    function openQuoteModal(service) {
        document.getElementById('quoteModal').style.display = 'block';
        
        const materialSelect = document.querySelector('#quoteForm select[name="material"]');
        if (service && materialSelect) {
            // Try to find matching option
            const options = materialSelect.querySelectorAll('option');
            for (let option of options) {
                if (option.value === service || option.textContent.includes(service)) {
                    materialSelect.value = option.value;
                    break;
                }
            }
        }
    }

    function closeQuoteModal() {
        document.getElementById('quoteModal').style.display = 'none';
    }

    async function submitQuoteForm(event) {
        event.preventDefault();
        const formData = new FormData(event.target);
        
        const quoteData = {
            company: formData.get('company'),
            contact: formData.get('contact'),
            email: formData.get('email'),
            material: formData.get('material'),
            volume: formData.get('volume'),
            timeline: formData.get('timeline'),
            requirements: formData.get('requirements'),
            date: new Date().toISOString(),
            type: 'quote'
        };
        
        // Try to save to Supabase
        try {
            const { data, error } = await supabase
                .from('inquiries')
                .insert([quoteData]);
                
            if (error) throw error;
            
            alert(`Thank you for your quote request! We will contact you soon.\n\nYour inquiry has been saved successfully.`);
        } catch (error) {
            console.error('Error saving quote:', error);
            alert(`Thank you for your quote request! We will contact you soon.\n\nYour inquiry will be sent to: ${contactSettings.primaryRecipient}`);
        }
        
        event.target.reset();
        closeQuoteModal();
    }

    async function submitForm(event) {
        event.preventDefault();
        const formData = new FormData(event.target);
        
        const inquiryData = {
            company: formData.get('company'),
            contact: formData.get('contact'),
            email: formData.get('email'),
            interest: formData.get('interest'),
            message: formData.get('message'),
            date: new Date().toISOString(),
            type: 'contact'
        };
        
        // Try to save to Supabase
        try {
            const { data, error } = await supabase
                .from('inquiries')
                .insert([inquiryData]);
                
            if (error) throw error;
            
            alert('Thank you for your message! We will contact you soon.\n\nYour inquiry has been saved successfully.');
        } catch (error) {
            console.error('Error saving inquiry:', error);
            alert(`Thank you for your message! We will contact you soon.\n\nYour inquiry will be sent to: ${contactSettings.primaryRecipient}`);
        }
        
        event.target.reset();
    }

    // Event listeners
    document.getElementById('searchInput').addEventListener('input', function(e) {
        if (e.target.value.length > 0) {
            searchProducts();
        } else {
            document.querySelectorAll('.category-card').forEach(card => {
                card.style.display = 'block';
            });
            document.getElementById('noResults').style.display = 'none';
        }
    });

    // Close modals when clicking outside
    window.onclick = function(event) {
        const quoteModal = document.getElementById('quoteModal');
        const productModal = document.getElementById('productModal');
        
        if (event.target == quoteModal) {
            quoteModal.style.display = 'none';
        }
        if (event.target == productModal) {
            productModal.style.display = 'none';
        }
    }
</script>
